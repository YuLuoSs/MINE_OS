.global OSCtxSw
.extern OSTaskSwHook
.extern OSTCBHighRdy
.extern OSTCBCur
.extern OSPrioHighRdy
.extern OSPrioCur
.extern OSTCBHighRdy
OSCtxSw:
	STMFD	SP!, {LR}           @PC
	STMFD	SP!, {R0-R12, LR}   @R0-R12 LR
	MRS		R0,  CPSR			@Push CPSR
	STMFD	SP!, {R0}
		
	@----------------------------------------------------------------------------------
	@ 		OSTCBCur->OSTCBStkPtr = SP
	@----------------------------------------------------------------------------------		
	LDR		R0, =OSTCBCur
	LDR		R0, [R0]
	STR		SP, [R0]
	
	@----------------------------------------------------------------------------------		
	@ OSTaskSwHook();
	@---------------------------------------------------------------------------------	
	BL 		OSTaskSwHook

	@----------------------------------------------------------------------------------			
	@ OSTCBCur = OSTCBHighRdy;
	@----------------------------------------------------------------------------------		
	LDR		R0, =OSTCBHighRdy
	LDR		R1, =OSTCBCur
	LDR		R0, [R0]
	STR		R0, [R1]
	
	@----------------------------------------------------------------------------------		
	@ OSPrioCur = OSPrioHighRdy;
	@----------------------------------------------------------------------------------		
	LDR		R0, =OSPrioHighRdy
	LDR		R1, =OSPrioCur
	LDRB	R0, [R0]
	STRB	R0, [R1]
	
	@----------------------------------------------------------------------------------		
	@  OSTCBHighRdy->OSTCBStkPtr;
	@----------------------------------------------------------------------------------		
	LDR		R0, =OSTCBHighRdy
	LDR		R0, [R0]
	LDR		SP, [R0]

	@----------------------------------------------------------------------------------	
	@Restore New task context
	@----------------------------------------------------------------------------------	
	LDMFD 	SP!, {R0}		@POP CPSR
	MSR 	SPSR_cxsf, R0
	LDMFD 	SP!, {R0-R12, LR, PC}^	
.global OSIntCtxSw
OSIntCtxSw:
	PUSH	{LR}
	@切换到SVC模式下，加载SP
	MRS		R0, CPSR
	MSR		CPSR_c, #0xd3
	MOV		R1,SP
	MSR		CPSR_cxsf, R0		@切换回当前模式

	@----------------------------------------------------------------------------------
	@ 		OSTCBCur->OSTCBStkPtr = SP
	@----------------------------------------------------------------------------------		
	LDR		R0, =OSTCBCur
	LDR		R0, [R0]
	STR		R1, [R0]
	
	@----------------------------------------------------------------------------------		
	@ OSTaskSwHook();
	@---------------------------------------------------------------------------------	
	BL 		OSTaskSwHook

	@----------------------------------------------------------------------------------			
	@ OSTCBCur = OSTCBHighRdy;
	@----------------------------------------------------------------------------------		
	LDR		R0, =OSTCBHighRdy
	LDR		R1, =OSTCBCur
	LDR		R0, [R0]
	STR		R0, [R1]
	
	@----------------------------------------------------------------------------------		
	@ OSPrioCur = OSPrioHighRdy;
	@----------------------------------------------------------------------------------		
	LDR		R0, =OSPrioHighRdy
	LDR		R1, =OSPrioCur
	LDRB	R0, [R0]
	STRB	R0, [R1]
	
	@----------------------------------------------------------------------------------		
	@ SP = OSTCBHighRdy->OSTCBStkPtr;
	@----------------------------------------------------------------------------------		
	LDR		R0, =OSTCBHighRdy
	LDR		R0, [R0]
	LDR		R1, [R0]
	
	@----------------------------------------------------------------------------------	
	@Restore New task context
	@----------------------------------------------------------------------------------	

	@切换到SVC模式下，加载SP
	MRS		R0, CPSR
	MSR		CPSR_c, #0xd3
	MOV		SP,R1
	MSR		CPSR_cxsf, R0	@切换回当前模式
	POP		{LR}
	BX		LR